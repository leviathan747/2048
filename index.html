<!DOCTYPE html>
<html lang="en">

<head>

  <title>2048</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta charset="UTF-8"/>

  <script type="application/javascript" src="https://unpkg.com/react@16.0.0/umd/react.production.min.js"></script>
  <script type="application/javascript" src="https://unpkg.com/react-dom@16.0.0/umd/react-dom.production.min.js"></script>
  <script type="application/javascript" src="https://unpkg.com/babel-standalone@6.26.0/babel.js"></script>

  <style>

    body {
      font: 55px "Century Gothic", Futura, sans-serif;
      margin: 20px;
    }

    button {
      font: 55px "Century Gothic", Futura, sans-serif;
      margin-bottom: 20px;
      margin-right: 20px;
    }
    
    .board-row:after {
      clear: both;
      content: "";
      display: table;
    }
    
    .square {
      background: #fff;
      border: 1px solid #999;
      float: left;
      font-size: 75px;
      font-weight: bold;
      line-height: 170px;
      height: 170px;
      margin-right: -1px;
      margin-top: -1px;
      padding: 0;
      text-align: center;
      width: 170px;
    }
    
    .square:focus {
      outline: none;
    }

    .red-text {
      color: red;
    }

  </style>

</head>

<body>
  <div id="root"></div>

  <script type="text/babel">

    const rootElement = document.getElementById('root');
   
    function Cell(props) {
      const val = props.value != 0 ? props.value : '';
      const classes = props.firstTime ? 'square red-text' : 'square';
      return (
        <div className={classes}>{val}</div>
      );
    }

    function GameRow(props) {
      return (
        <div className="board-row">{props.cells}</div>
      );
    }

    class Game extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          size: 4,
          cells: [],
          score: 0,
          newCell: 0
        }
      }

      resetGame(state) {
        state.cells = new Array(state.size * state.size);
        state.cells.fill(0);
        state.score = 0;
        return state;
      }

      generateCell(state) {
        const emptyCells = [];
        for (var i = 0; i < state.cells.length; i++ ) {
          if (state.cells[i] == 0) {
            emptyCells.push(i);
          }
        }
        state.newCell = emptyCells[Math.floor(Math.random() * emptyCells.length)]
        state.cells[state.newCell] = 2;
        return state;
      }

      collapse(row, state) {
        const len = row.length;
        row = row.filter(x => (x != 0));  // remove 0s
        for (var i = 1; i < row.length; i++) {  // combine pairs
          if (row[i-1] == row[i]) {
            row[i-1] = row[i-1] + row[i];
            row[i] = 0;
            state.score += row[i-1];
          }
        }
        row = row.filter(x => (x != 0));  // remove 0s again
        row = row.concat(new Array(len - row.length).fill(0));  // pad with 0s back to original size
        return row;
      }

      doMove(code) {
        let state = this.state;
        let cells = [];
        let colcells = []
        switch (code) {
        case 0:  // right to left
          for (var i = 0; i < state.size; i++) {
            const row = state.cells.slice(i * state.size, i * state.size + state.size);
            cells = cells.concat(this.collapse(row, state));
          }
          break;
        case 1:  // bottom to top
          for (var i = 0; i < state.size; i++) {
            const col = [];
            for (var j = 0; j < state.size; j++) {
              col.push(state.cells[j * state.size + i]);
            }
            colcells = colcells.concat(this.collapse(col, state));
          }
          for (var i = 0; i < state.size; i++) {
            for (var j = 0; j < state.size; j++) {
              cells[j * state.size + i] = colcells[i * state.size + j];
            }
          }
          break;
        case 2:  // left to right
          for (var i = 0; i < state.size; i++) {
            const row = state.cells.slice(i * state.size, i * state.size + state.size);
            cells = cells.concat(this.collapse(row.reverse(), state).reverse());
          }
          break;
        case 3:  // top to bottom
          for (var i = 0; i < state.size; i++) {
            const col = [];
            for (var j = 0; j < state.size; j++) {
              col.push(state.cells[j * state.size + i]);
            }
            colcells = colcells.concat(this.collapse(col.reverse(), state).reverse());
          }
          for (var i = 0; i < state.size; i++) {
            for (var j = 0; j < state.size; j++) {
              cells[j * state.size + i] = colcells[i * state.size + j];
            }
          }
          break;
     
        default:
          cells = state.cells;
          console.log('Invalid move code');
        }
        if (JSON.stringify(cells) != JSON.stringify(state.cells)) {
          state.cells = cells;
          state = this.generateCell(state);
        }
        this.setState(state);
      }

      componentDidMount() {
        let state = this.resetGame(this.state);
        state = this.generateCell(state);
        this.setState(state);
        const game = this;
        window.addEventListener('keydown', function(e) {handleKeypress(game, e)});
      }

      render() {
        const rows = [];
        for (var i = 0; i < this.state.size; i++) {
          const row = []
          for (var j = 0; j < this.state.size; j++) {
            const index = i * this.state.size + j;
            row.push(<Cell value={this.state.cells[index]} firstTime={this.state.newCell == index} />);
          }
          rows.push(<GameRow cells={row} />);
        }
        const game = this;
        const doReset = function() {
          let state = game.resetGame(game.state);
          state = game.generateCell(state);
          game.setState(state);
        }
        return (
          <div>
            <button onClick={doReset}>Reset</button>
            <span>Score: {this.state.score}</span>
            <div>{rows}</div>
          </div>
        );
      }
    }

    function handleKeypress(game, event) {
      if (event.keyCode >= 37 && event.keyCode <= 40) {
        game.doMove(event.keyCode - 37);
      }
    }

    ReactDOM.render(<Game/>, rootElement);

  </script>

</body>

</html>
