<!DOCTYPE html>
<html lang="en">

<head>

  <title>2048</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta charset="UTF-8"/>

  <script type="application/javascript" src="https://unpkg.com/react@16.0.0/umd/react.production.min.js"></script>
  <script type="application/javascript" src="https://unpkg.com/react-dom@16.0.0/umd/react-dom.production.min.js"></script>
  <script type="application/javascript" src="https://unpkg.com/babel-standalone@6.26.0/babel.js"></script>

  <style>

    body, button, label, input {
      font: 20px "Century Gothic", Futura, sans-serif;
      margin: 20px;
    }

    #urlinput {
      width: 350px;
    }

    .board-row:after {
      clear: both;
      content: "";
      display: table;
    }
    
    .square {
      background: #fff;
      border: 1px solid #999;
      float: left;
      font-size: 75px;
      font-weight: bold;
      line-height: 170px;
      height: 170px;
      margin-right: -1px;
      margin-top: -1px;
      padding: 0;
      text-align: center;
      width: 170px;
    }
    
    .square:focus {
      outline: none;
    }

    .red-text {
      color: red;
    }

  </style>

</head>

<body>
  <div id="root"></div>

  <script type="text/babel">

    const rootElement = document.getElementById('root');
   
    function Cell(props) {
      const val = props.value != 0 ? props.value : '';
      const classes = props.firstTime ? 'square red-text' : 'square';
      return (
        <div className={classes}>{val}</div>
      );
    }

    function GameRow(props) {
      return (
        <div className="board-row">{props.cells}</div>
      );
    }

    function PlayButton(props) {
      return (
        <input type="submit" value="Play" />
      );
    }

    class StopButton extends React.Component {
      constructor(props) {
        super(props);
        this.state = {intervalId: null}
      }

      componentDidMount() {
        this.setState({intervalId: setInterval(this.props.callback, this.props.interval)});
      }

      componentWillUnmount() {
        clearInterval(this.state.intervalId);
      }

      render() {
        return (
          <input type="submit" value="Stop" />
        );
      }
    }

    class Game extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          size: 4,
          cells: [],
          score: 0,
          newCell: 0,
          url: '',
          autoPlayOn: false,
          autoPlayInterval: 100
        }
        this.resetGame = this.resetGame.bind(this);
        this.generateCell = this.generateCell.bind(this);
        this.collapse = this.collapse.bind(this);
        this.doMove = this.doMove.bind(this);
        this.handleURLChange = this.handleURLChange.bind(this);
        this.handleAutoPlay = this.handleAutoPlay.bind(this);
        this.getAutoMove = this.getAutoMove.bind(this);
        this.handleKeypress = this.handleKeypress.bind(this);
      }

      resetGame(state) {
        state.cells = new Array(state.size * state.size);
        state.cells.fill(0);
        state.score = 0;
        return state;
      }

      generateCell(state) {
        const emptyCells = [];
        for (var i = 0; i < state.cells.length; i++ ) {
          if (state.cells[i] == 0) {
            emptyCells.push(i);
          }
        }
        state.newCell = emptyCells[Math.floor(Math.random() * emptyCells.length)]
        state.cells[state.newCell] = 2;
        return state;
      }

      collapse(row, state) {
        const len = row.length;
        row = row.filter(x => (x != 0));  // remove 0s
        for (var i = 1; i < row.length; i++) {  // combine pairs
          if (row[i-1] == row[i]) {
            row[i-1] = row[i-1] + row[i];
            row[i] = 0;
            state.score += row[i-1];
          }
        }
        row = row.filter(x => (x != 0));  // remove 0s again
        row = row.concat(new Array(len - row.length).fill(0));  // pad with 0s back to original size
        return row;
      }

      doMove(code) {
        let state = this.state;
        let cells = [];
        let colcells = []
        switch (code) {
        case 0:  // right to left
          for (var i = 0; i < state.size; i++) {
            const row = state.cells.slice(i * state.size, i * state.size + state.size);
            cells = cells.concat(this.collapse(row, state));
          }
          break;
        case 1:  // bottom to top
          for (var i = 0; i < state.size; i++) {
            const col = [];
            for (var j = 0; j < state.size; j++) {
              col.push(state.cells[j * state.size + i]);
            }
            colcells = colcells.concat(this.collapse(col, state));
          }
          for (var i = 0; i < state.size; i++) {
            for (var j = 0; j < state.size; j++) {
              cells[j * state.size + i] = colcells[i * state.size + j];
            }
          }
          break;
        case 2:  // left to right
          for (var i = 0; i < state.size; i++) {
            const row = state.cells.slice(i * state.size, i * state.size + state.size);
            cells = cells.concat(this.collapse(row.reverse(), state).reverse());
          }
          break;
        case 3:  // top to bottom
          for (var i = 0; i < state.size; i++) {
            const col = [];
            for (var j = 0; j < state.size; j++) {
              col.push(state.cells[j * state.size + i]);
            }
            colcells = colcells.concat(this.collapse(col.reverse(), state).reverse());
          }
          for (var i = 0; i < state.size; i++) {
            for (var j = 0; j < state.size; j++) {
              cells[j * state.size + i] = colcells[i * state.size + j];
            }
          }
          break;
     
        default:
          cells = state.cells;
          console.log('Invalid move code');
        }
        if (JSON.stringify(cells) != JSON.stringify(state.cells)) {
          state.cells = cells;
          state = this.generateCell(state);
        }
        this.setState(state);
      }

      handleURLChange(event) {
        const state = this.state;
        state.url = event.target.value;
        this.setState(state);
      }

      handleAutoPlay(event) {
        const state = this.state;
        state.autoPlayOn = state.autoPlayOn ? false : true;
        this.setState(state);
        event.preventDefault();
      }

      getAutoMove() {
        const game = this;
        fetch(this.state.url, {
          method: 'post',
          body: JSON.stringify(this.state)
        }).then(function (resp) {  
          return resp.json();
        }).then(function(data) {
          if (data != undefined && data.move != undefined && data.move >= 0 && data.move <= 3) {
            game.doMove(data.move);
          }
        })  
        .catch(function (error) {  
          console.log('Request failure: ', error);  
        });
      }

      handleKeypress(event) {
        if (event.keyCode >= 37 && event.keyCode <= 40) {
          this.doMove(event.keyCode - 37);
        }
      }

      componentDidMount() {
        let state = this.resetGame(this.state);
        state = this.generateCell(state);
        this.setState(state);
        window.addEventListener('keydown', this.handleKeypress);
      }

      render() {
        const rows = [];
        for (var i = 0; i < this.state.size; i++) {
          const row = []
          for (var j = 0; j < this.state.size; j++) {
            const index = i * this.state.size + j;
            row.push(<Cell value={this.state.cells[index]} firstTime={this.state.newCell == index} />);
          }
          rows.push(<GameRow cells={row} />);
        }
        const game = this;
        const doReset = function() {
          let state = game.resetGame(game.state);
          state = game.generateCell(state);
          game.setState(state);
        }
        return (
          <div>
            <button onClick={doReset}>Reset</button>
            <span>Score: {this.state.score}</span>
            <div>{rows}</div>
            <form onSubmit={this.handleAutoPlay}>
              <label>
                Auto-play URL:
                <input id="urlinput" type="text" value={this.state.url} onChange={this.handleURLChange} />
              </label>
              {this.state.autoPlayOn ? (
              <StopButton callback={this.getAutoMove} interval={this.state.autoPlayInterval} />
              ) : (
              <PlayButton />
              )}
            </form>
          </div>
        );
      }
    }

    ReactDOM.render(<Game/>, rootElement);

  </script>

</body>

</html>
